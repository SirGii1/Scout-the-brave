<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Token Transfer</title>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solana/spl-token@latest/lib/index.iife.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: #121212;
            color: #f0f0f0;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600;
            color: #9945ff;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 14px;
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 8px;
            color: white;
            font-size: 16px;
        }
        
        input:focus {
            outline: none;
            border-color: #9945ff;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: #9945ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #824ee0;
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }
        
        .status.success {
            background: rgba(76, 175, 80, 0.15);
            border: 1px solid #4caf50;
            color: #4caf50;
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.15);
            border: 1px solid #f44336;
            color: #f44336;
        }
        
        .status.processing {
            background: rgba(33, 150, 243, 0.15);
            border: 1px solid #2196f3;
            color: #2196f3;
        }
        
        .wallet-info {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .connected-address {
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            color: #9945ff;
        }
        
        .balance-value {
            font-weight: bold;
            color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Solana Token Transfer</h1>
        
        <form id="transferForm">
            <div class="input-group">
                <label for="recipientAddress">Recipient Wallet Address</label>
                <input 
                    type="text" 
                    id="recipientAddress" 
                    placeholder="Enter Solana wallet address"
                    required
                >
            </div>
            
            <div class="wallet-info" id="walletInfo">
                <div class="info-row">
                    <span>Wallet:</span>
                    <span id="walletAddress" class="connected-address">Not connected</span>
                </div>
                <div class="info-row">
                    <span>SOL Balance:</span>
                    <span id="solBalance" class="balance-value">0 SOL</span>
                </div>
                <div class="info-row">
                    <span>Portfolio Value:</span>
                    <span id="portfolioValue" class="balance-value">$0.00</span>
                </div>
                <div class="info-row">
                    <span>Tokens:</span>
                    <span id="tokenCount">0</span>
                </div>
                <div class="info-row">
                    <span>Transactions:</span>
                    <span id="txCount">0</span>
                </div>
            </div>
            
            <button type="submit" id="sendButton">
                Send All Tokens
            </button>
        </form>
        
        <button id="connectWallet">
            Connect Wallet
        </button>
        
        <div class="status" id="statusMessage"></div>
    </div>

    <script>
        // Global variables
        let connection;
        let walletPublicKey;
        let tokenAccounts = [];
        let solBalance = 0;
        let portfolioValue = 0;
        
        // RPC endpoints with fallbacks
        const rpcEndpoints = [
            'https://solana-mainnet.rpc.extrnode.com',
            'https://rpc.ankr.com/solana',
            solanaWeb3.clusterApiUrl('mainnet-beta')
        ];
        
        let currentEndpointIndex = 0;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Try connecting to RPC endpoints in order
                connection = await connectToRpc();
                console.log('Connected to Solana RPC');
                
                // Check if Phantom is already connected
                if (window.solana && window.solana.isPhantom && window.solana.isConnected) {
                    walletPublicKey = window.solana.publicKey;
                    document.getElementById('connectWallet').textContent = 'Wallet Connected';
                    document.getElementById('walletInfo').style.display = 'block';
                    updateWalletDisplay();
                    await Promise.all([getSolBalance(), getTokenAccounts()]);
                    calculatePortfolioValue();
                }
                
                // Set up event listeners after DOM is ready
                setupEventListeners();
            } catch (error) {
                console.error('Connection error:', error);
                showStatus('Network connection failed', 'error');
            }
        });
        
        // Set up event listeners
        function setupEventListeners() {
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('transferForm').addEventListener('submit', transferTokens);
        }
        
        // Try connecting to RPC endpoints with fallback
        async function connectToRpc() {
            for (let i = 0; i < rpcEndpoints.length; i++) {
                try {
                    const conn = new solanaWeb3.Connection(rpcEndpoints[i], 'confirmed');
                    // Test connection
                    await conn.getEpochInfo();
                    currentEndpointIndex = i;
                    return conn;
                } catch (err) {
                    console.warn(`RPC endpoint failed: ${rpcEndpoints[i]}`);
                    continue;
                }
            }
            throw new Error('All RPC endpoints failed');
        }
        
        // Retry function for RPC calls
        async function retryRpcCall(fn, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    
                    // Switch to next RPC endpoint on 403 error
                    if (error.message && error.message.includes('403')) {
                        console.log('Switching to next RPC endpoint due to 403 error');
                        currentEndpointIndex = (currentEndpointIndex + 1) % rpcEndpoints.length;
                        connection = new solanaWeb3.Connection(rpcEndpoints[currentEndpointIndex], 'confirmed');
                    }
                    
                    console.log(`Retrying... (${i+1}/${retries})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // Connect wallet
        async function connectWallet() {
            const button = document.getElementById('connectWallet');
            const originalText = button.textContent;
            button.textContent = 'Connecting...';
            button.disabled = true;
            
            try {
                // Check for Phantom wallet
                if (!(window.solana && window.solana.isPhantom)) {
                    throw new Error('Phantom wallet required. Get it at phantom.app');
                }
                
                // Connect to wallet
                const response = await window.solana.connect();
                walletPublicKey = response.publicKey;
                
                // Update UI
                button.textContent = 'Wallet Connected';
                document.getElementById('walletInfo').style.display = 'block';
                updateWalletDisplay();
                
                // Get balances
                await Promise.all([getSolBalance(), getTokenAccounts()]);
                calculatePortfolioValue();
                
                showStatus('Wallet connected successfully!', 'success');
            } catch (error) {
                console.error('Wallet error:', error);
                showStatus(error.message || 'Connection failed', 'error');
                button.textContent = originalText;
            } finally {
                button.disabled = false;
            }
        }
        
        // Update wallet display with shortened address
        function updateWalletDisplay() {
            if (!walletPublicKey) return;
            
            const fullAddress = walletPublicKey.toString();
            const shortAddress = `${fullAddress.substring(0, 6)}...${fullAddress.substring(fullAddress.length - 4)}`;
            document.getElementById('walletAddress').textContent = shortAddress;
            document.getElementById('walletAddress').title = fullAddress;
        }
        
        // Get SOL balance
        async function getSolBalance() {
            if (!walletPublicKey) return;
            
            try {
                const balance = await retryRpcCall(() => connection.getBalance(walletPublicKey));
                solBalance = balance / solanaWeb3.LAMPORTS_PER_SOL;
                document.getElementById('solBalance').textContent = `${solBalance.toFixed(4)} SOL`;
            } catch (error) {
                console.error('SOL balance error:', error);
                showStatus('Failed to fetch SOL balance', 'error');
            }
        }
        
        // Get token accounts
        async function getTokenAccounts() {
            if (!walletPublicKey) return;
            
            try {
                const response = await retryRpcCall(() => 
                    connection.getParsedTokenAccountsByOwner(
                        walletPublicKey,
                        { programId: new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA') }
                    )
                );
                
                tokenAccounts = response.value.map(account => {
                    const data = account.account.data.parsed.info;
                    return {
                        pubkey: account.pubkey,
                        mint: new solanaWeb3.PublicKey(data.mint),
                        amount: data.tokenAmount.amount,
                        decimals: data.tokenAmount.decimals,
                        uiAmount: data.tokenAmount.uiAmount
                    };
                });
                
                // Update UI
                document.getElementById('tokenCount').textContent = tokenAccounts.length;
                document.getElementById('txCount').textContent = tokenAccounts.length;
                
            } catch (error) {
                console.error('Token error:', error);
                showStatus('Failed to fetch tokens', 'error');
            }
        }
        
        // Calculate portfolio value (simplified)
        function calculatePortfolioValue() {
            // In a real app, you would fetch current token prices
            // For demo purposes, we'll use a fixed value per token
            const tokenValue = 1.5; // $1.50 per token
            const totalTokenValue = tokenAccounts.reduce((sum, token) => sum + (token.uiAmount || 0) * tokenValue, 0);
            portfolioValue = solBalance * 100 + totalTokenValue; // Assuming 1 SOL = $100
            
            document.getElementById('portfolioValue').textContent = `$${portfolioValue.toFixed(2)}`;
        }
        
        // Transfer tokens
        async function transferTokens(e) {
            e.preventDefault();
            
            if (!walletPublicKey) {
                showStatus('Connect wallet first', 'error');
                return;
            }
            
            const recipientAddress = document.getElementById('recipientAddress').value.trim();
            
            // Validate address
            let recipientPubKey;
            try {
                recipientPubKey = new solanaWeb3.PublicKey(recipientAddress);
            } catch (error) {
                showStatus('Invalid wallet address', 'error');
                return;
            }
            
            // Prepare UI
            const sendButton = document.getElementById('sendButton');
            const originalText = sendButton.textContent;
            sendButton.textContent = 'Processing...';
            sendButton.disabled = true;
            
            try {
                // Create transaction
                const transaction = new solanaWeb3.Transaction();
                
                // Add token transfers
                for (const tokenAccount of tokenAccounts) {
                    // Skip tokens with zero balance
                    if (BigInt(tokenAccount.amount) === 0n) continue;
                    
                    // Get recipient's associated token address
                    const associatedTokenAddress = await splToken.getAssociatedTokenAddress(
                        tokenAccount.mint,
                        recipientPubKey
                    );
                    
                    // Check if recipient account exists
                    const accountInfo = await retryRpcCall(() => 
                        connection.getAccountInfo(associatedTokenAddress)
                    );
                    
                    if (!accountInfo) {
                        // Create account if it doesn't exist
                        const createInstruction = splToken.createAssociatedTokenAccountInstruction(
                            walletPublicKey,
                            associatedTokenAddress,
                            recipientPubKey,
                            tokenAccount.mint
                        );
                        transaction.add(createInstruction);
                    }
                    
                    // Transfer tokens
                    const transferInstruction = splToken.createTransferCheckedInstruction(
                        tokenAccount.pubkey,
                        tokenAccount.mint,
                        associatedTokenAddress,
                        walletPublicKey,
                        BigInt(tokenAccount.amount),
                        tokenAccount.decimals
                    );
                    transaction.add(transferInstruction);
                }
                
                // Check if there are any tokens to transfer
                if (transaction.instructions.length === 0) {
                    throw new Error('No tokens to transfer');
                }
                
                // Get recent blockhash with retry
                const { blockhash } = await retryRpcCall(() => connection.getLatestBlockhash());
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = walletPublicKey;
                
                // Sign and send transaction using Phantom
                const signedTransaction = await window.solana.signTransaction(transaction);
                const signature = await retryRpcCall(() => 
                    connection.sendRawTransaction(signedTransaction.serialize())
                );
                
                // Confirm transaction
                const confirmation = await retryRpcCall(() => 
                    connection.confirmTransaction({
                        signature: signature,
                        blockhash: blockhash,
                        lastValidBlockHeight: (await connection.getEpochInfo()).blockHeight + 150
                    })
                );
                
                if (confirmation.value.err) {
                    throw new Error('Transaction failed');
                }
                
                // Update UI
                showStatus(`Success! Tokens sent. Signature: ${signature.substring(0, 20)}...`, 'success');
                sendButton.textContent = 'Transfer Complete!';
                
                // Reset form
                document.getElementById('transferForm').reset();
                
                // Refresh balances
                await Promise.all([getSolBalance(), getTokenAccounts()]);
                calculatePortfolioValue();
                
            } catch (error) {
                console.error('Transfer error:', error);
                showStatus(`Transfer failed: ${error.message || 'Unknown error'}`, 'error');
                sendButton.textContent = originalText;
            } finally {
                sendButton.disabled = false;
            }
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            statusDiv.style.display = 'block';
            
            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>